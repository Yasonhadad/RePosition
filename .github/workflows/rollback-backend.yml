# Rollback Backend: deploy a previous Docker image by digest on EKS
name: Rollback Backend (by Digest)

on:
  workflow_dispatch:
    inputs:
      digest:
        description: "ECR image digest (e.g. sha256:a1b2c3d4e5f6...). ECR → Repositories → reposition → Images → copy Image digest"
        required: true
        type: string

env:
  AWS_REGION: ${{ vars.AWS_REGION || 'eu-west-1' }}
  ECR_REPOSITORY: ${{ vars.ECR_REPOSITORY || 'reposition' }}
  EKS_CLUSTER: ${{ vars.EKS_CLUSTER || 'reposition' }}

jobs:
  rollback:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Validate digest format
        run: |
          DIGEST="${{ github.event.inputs.digest }}"
          if [[ ! "$DIGEST" =~ ^sha256:[a-fA-F0-9]+$ ]]; then
            echo "Invalid digest. Use format sha256:xxx (64 hex chars). Copy from ECR → Images → Image digest"
            exit 1
          fi

      - name: Get ECR repository URI
        id: ecr
        run: |
          REPO_URI=$(aws ecr describe-repositories --repository-names $ECR_REPOSITORY --query 'repositories[0].repositoryUri' --output text --region $AWS_REGION)
          IMAGE="${REPO_URI}@${{ github.event.inputs.digest }}"
          echo "image=$IMAGE" >> $GITHUB_OUTPUT
          echo "Rolling back to image: $IMAGE"

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --name $EKS_CLUSTER --region $AWS_REGION

      - name: Set deployment image to rollback digest
        run: |
          kubectl set image deployment/reposition \
            reposition=${{ steps.ecr.outputs.image }} \
            -n reposition
          kubectl rollout status deployment/reposition -n reposition --timeout=300s
          echo "Rollback complete."
