# Rollback Frontend: deploy a previous commit's build to S3
# Use when the latest frontend has issues and you need to revert.
name: Rollback Frontend (by Commit)

on:
  workflow_dispatch:
    inputs:
      commit_sha:
        description: "Git commit SHA of the version to deploy (e.g. abc123f). Find in GitHub â†’ Commits"
        required: true
        type: string

env:
  AWS_REGION: ${{ vars.AWS_REGION || 'eu-west-1' }}
  S3_BUCKET: ${{ vars.S3_BUCKET }}
  CLOUDFRONT_DISTRIBUTION_ID: ${{ vars.CLOUDFRONT_DISTRIBUTION_ID }}
  VITE_API_URL: ${{ vars.VITE_API_URL }}

jobs:
  rollback:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Require S3 and CloudFront vars
        run: |
          if [ -z "$S3_BUCKET" ] || [ -z "$CLOUDFRONT_DISTRIBUTION_ID" ]; then
            echo "Set GitHub variables S3_BUCKET and CLOUDFRONT_DISTRIBUTION_ID"
            exit 1
          fi

      - name: Checkout specific commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.commit_sha }}
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build
        env:
          VITE_API_URL: ${{ env.VITE_API_URL }}

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Sync to S3 (rollback)
        run: |
          aws s3 sync dist/public s3://$S3_BUCKET --delete
          echo "Deployed build from commit ${{ github.event.inputs.commit_sha }}"

      - name: Invalidate CloudFront
        run: |
          aws cloudfront create-invalidation \
            --distribution-id $CLOUDFRONT_DISTRIBUTION_ID \
            --paths "/*"
          echo "Rollback complete. CloudFront cache invalidated."
